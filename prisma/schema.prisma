generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////////

enum RoleName {
  MASTER_ADMIN
  SUB_ADMIN
  WORKER
}

enum SupportStatus {
  SUPPORTER
  NEUTRAL
  OPPONENT
  UNKNOWN
}

//////////////////////////////////////////////////////
// TENANT (Candidate)
//////////////////////////////////////////////////////

model Tenant {
  id                   Int      @id @default(autoincrement())
  candidateName        String
  partyName            String?
  partyLogoUrl         String? @db.Text
  candidatePhotoUrl    String? @db.Text
  electionType         String?
  constituencyName     String
  constituencyNumber   String?
  status               Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  users                User[]
  voters               Voter[]
  families             Family[]
  activityLogs         ActivityLog[]
  exportLogs           ExportLog[]
  voterUpdateLogs      VoterUpdateLog[]
}

//////////////////////////////////////////////////////
// ROLE
//////////////////////////////////////////////////////

model Role {
  id        Int       @id @default(autoincrement())
  name      RoleName  @unique
  users     User[]
}

//////////////////////////////////////////////////////
// USER
//////////////////////////////////////////////////////

model User {
  id              Int       @id @default(autoincrement())
  tenantId        Int?
  roleId          Int
  name            String
  mobileNumber    String    @unique
  passwordHash    String?
  status          Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  tenant          Tenant?   @relation(fields: [tenantId], references: [id])
  role            Role      @relation(fields: [roleId], references: [id])
  voterUpdates    VoterUpdateLog[]
  activityLogs    ActivityLog[]
  exportLogs      ExportLog[]

  @@index([tenantId])
}


//////////////////////////////////////////////////////
// FAMILY
//////////////////////////////////////////////////////

model Family {
  id            Int      @id @default(autoincrement())
  tenantId      Int
  headVoterId   Int?
  createdAt     DateTime @default(now())

  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  voters        Voter[]

  @@index([tenantId])
}

//////////////////////////////////////////////////////
// VOTER
//////////////////////////////////////////////////////

model Voter {
  id               Int      @id @default(autoincrement())
  
  // Relations
  tenantId         Int
  tenant           Tenant   @relation(fields: [tenantId], references: [id])

  // Official Voting Details
  epicNumber       String   // Card Number (e.g., RJH1200054) - Extremely Important
  serialNumber     Int?     // Sr.No

  // Demographics
  fullName         String
  firstName        String?
  middleName       String?
  lastName         String?
  gender           String?  // We will normalize this to 'MALE', 'FEMALE', 'OTHER'
  age              Int?
  mobileNumber     String?
    familyId        Int?
    language         String?

  family          Family?        @relation(fields: [familyId], references: [id])


  // Location Data
  parlConstituency String?  // संसदीय मतदारसंघाचे नाव क्र
  asmConstituency  String?  // विधानसभा मतदारसंघ नाव
  cityVillage      String?  // मुख्य शहर
  gramPanchayat    String?  // ग्रामपंचायत
  houseNumber      String?  // घर क्र
  ward             String?  // वार्ड
  pollingStation   String?  // मतदान केंद्र
  address          String?  // पत्ता

  // Additional Meta
  caste            String?  // Cast
  otherInfo        String?  // Other Information
  photoUrl         String?  // Photo

  // CRM Tracking Metrics (Crucial for your PWA)
  isAlive         Boolean        @default(true)
  isVisited        Boolean  @default(false)
  hasVoted         Boolean  @default(false)
  supportLevel     String   @default("UNKNOWN") // UNKNOWN, STRONG, WEAK, OPPOSITION

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
    updateLogs      VoterUpdateLog[]
      lastUpdatedBy   Int?
  lastUpdatedAt   DateTime       @default(now())

  notes           String?


  // A voter's EPIC card should be unique per campaign/tenant
  
  // Indexes to make searching blazingly fast in the dashboard
  @@index([tenantId, pollingStation])
  @@index([tenantId, ward])
}

//////////////////////////////////////////////////////
// VOTER UPDATE LOG
//////////////////////////////////////////////////////

model VoterUpdateLog {
  id          Int      @id @default(autoincrement())
  tenantId    Int
  voterId     Int
  userId      Int
  fieldName   String
  oldValue    String?
  newValue    String?
  createdAt   DateTime @default(now())

  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  voter       Voter    @relation(fields: [voterId], references: [id])
  user        User     @relation(fields: [userId], references: [id])

  @@index([tenantId])
}

//////////////////////////////////////////////////////
// ACTIVITY LOG
//////////////////////////////////////////////////////

model ActivityLog {
  id          Int      @id @default(autoincrement())
  tenantId    Int
  userId      Int
  action      String
  description String?
  createdAt   DateTime @default(now())

  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  user        User     @relation(fields: [userId], references: [id])

  @@index([tenantId])
}

//////////////////////////////////////////////////////
// EXPORT LOG
//////////////////////////////////////////////////////

model ExportLog {
  id          Int      @id @default(autoincrement())
  tenantId    Int
  userId      Int
  exportType  String
  filtersJson Json?
  createdAt   DateTime @default(now())

  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  user        User     @relation(fields: [userId], references: [id])

  @@index([tenantId])
}

//////////////////////////////////////////////////////
// OTP
//////////////////////////////////////////////////////

model Otp {
  id           Int      @id @default(autoincrement())
  mobileNumber String
  codeHash     String
  expiresAt    DateTime
  verified     Boolean  @default(false)
  createdAt    DateTime @default(now())

  @@index([mobileNumber])
}
